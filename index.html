<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Waffle Hardware Provisioner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #fafafa;
            color: #0a0a0a;
            font-size: 16px;
            line-height: 1.5;
            padding-bottom: 40px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            color: #71717a;
            font-size: 14px;
        }

        .customer-name-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .customer-name-section label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .customer-name-section input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e4e4e7;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
        }

        .customer-name-section input:focus {
            outline: none;
            border-color: #71717a;
        }

        .progress-bar {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
            z-index: 100;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            padding: 8px 4px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: #a1a1aa;
            background: #fafafa;
        }

        .progress-step.active {
            background: #0a0a0a;
            color: white;
        }

        .progress-step.completed {
            background: #f0fdf4;
            color: #166534;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            margin-top: 20px;
        }

        .station-card {
            border: 1px solid #e4e4e7;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .station-title {
            font-weight: 600;
            font-size: 15px;
        }

        .remove-station-btn {
            background: #fef2f2;
            color: #991b1b;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e4e4e7;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            background: white;
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e4e4e7;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-item label {
            font-size: 14px;
            cursor: pointer;
            user-select: none;
        }

        .counter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .counter-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .counter-label {
            font-size: 14px;
            font-weight: 500;
        }

        .counter-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .counter-btn {
            width: 36px;
            height: 36px;
            border: 1px solid #e4e4e7;
            background: white;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            transition: all 0.2s;
        }

        .counter-btn:hover {
            background: #fafafa;
        }

        .counter-btn:active {
            background: #f4f4f5;
        }

        .counter-value {
            font-size: 16px;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }

        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .button-group-item {
            flex: 1;
            min-width: 120px;
            padding: 10px 16px;
            border: 1px solid #e4e4e7;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .button-group-item:hover {
            background: #fafafa;
        }

        .button-group-item.selected {
            background: #0a0a0a;
            color: white;
            border-color: #0a0a0a;
        }

        .add-btn {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-top: 12px;
        }

        .warning {
            background: #fff7ed;
            border: 1px solid #fed7aa;
            color: #9a3412;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 12px;
            line-height: 1.5;
        }

        .info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 12px;
            line-height: 1.5;
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .nav-btn {
            flex: 1;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .nav-btn.primary {
            background: #0a0a0a;
            color: white;
        }

        .nav-btn.primary:hover {
            background: #18181b;
        }

        .nav-btn.secondary {
            background: white;
            color: #0a0a0a;
            border: 1px solid #e4e4e7;
        }

        .nav-btn.secondary:hover {
            background: #fafafa;
        }

        .printer-card {
            border: 1px solid #e4e4e7;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .printer-header {
            font-weight: 600;
            margin-bottom: 12px;
            color: #0a0a0a;
        }

        .review-section {
            margin-bottom: 24px;
        }

        .review-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e4e4e7;
        }

        .review-item {
            padding: 8px 0;
            font-size: 14px;
        }

        .review-item-indent {
            padding-left: 20px;
            color: #71717a;
        }

        .complexity-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
        }

        .complexity-low {
            background: #f0fdf4;
            color: #166534;
        }

        .complexity-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .complexity-high {
            background: #fef2f2;
            color: #991b1b;
        }

        .copy-btn {
            background: #0a0a0a;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
        }

        .copy-btn:hover {
            background: #18181b;
        }

        .help-text {
            font-size: 13px;
            color: #71717a;
            margin-top: 4px;
        }

        @media (max-width: 640px) {
            .container {
                padding: 12px;
            }

            .header {
                padding: 20px 16px;
            }

            .header h1 {
                font-size: 20px;
            }

            .card {
                padding: 20px 16px;
            }

            .progress-bar {
                top: 12px;
                padding: 12px 16px;
            }

            .progress-step {
                font-size: 11px;
                padding: 6px 2px;
            }

            .counter-group {
                grid-template-columns: 1fr;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group-item {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Waffle Hardware Provisioner</h1>
            <p>Configure POS stations, printers, and network equipment for your customer</p>
        </div>

        <div class="customer-name-section">
            <label for="customerName">Customer Name *</label>
            <input type="text" id="customerName" placeholder="Enter customer business name" oninput="saveState()">
        </div>

        <div class="progress-bar">
            <div class="progress-steps">
                <div class="progress-step active" onclick="goToStep(1)">Stations</div>
                <div class="progress-step" onclick="goToStep(2)">Printers</div>
                <div class="progress-step" onclick="goToStep(3)">Placement</div>
                <div class="progress-step" onclick="goToStep(4)">Infrastructure</div>
                <div class="progress-step" onclick="goToStep(5)">Review</div>
            </div>
        </div>

        <!-- Step 1: POS Stations -->
        <div id="step1" class="step-content active">
            <div class="card">
                <h2>POS Stations</h2>
                <p class="help-text" style="margin-bottom: 16px;">Each station represents a checkout point. Configure iPads only.</p>
                
                <div id="stationsContainer"></div>
                
                <button class="add-btn" onclick="addStation()">+ Add Station</button>

                <div id="step1Warnings"></div>

                <h3>Peripherals</h3>
                <p class="help-text" style="margin-bottom: 12px;">Total peripherals needed (AMs will allocate to stations on-site)</p>
                
                <div class="counter-group">
                    <div class="counter-item">
                        <div class="counter-label">POS Stands</div>
                        <div class="counter-controls">
                            <button class="counter-btn" onclick="updateCounter('standsCount', -1)">‚àí</button>
                            <div class="counter-value" id="standsCount">0</div>
                            <button class="counter-btn" onclick="updateCounter('standsCount', 1)">+</button>
                        </div>
                    </div>
                    <div class="counter-item">
                        <div class="counter-label">Cash Drawers</div>
                        <div class="counter-controls">
                            <button class="counter-btn" onclick="updateCounter('drawersCount', -1)">‚àí</button>
                            <div class="counter-value" id="drawersCount">0</div>
                            <button class="counter-btn" onclick="updateCounter('drawersCount', 1)">+</button>
                        </div>
                    </div>
                    <div class="counter-item">
                        <div class="counter-label">Card Readers</div>
                        <div class="counter-controls">
                            <button class="counter-btn" onclick="updateCounter('readersCount', -1)">‚àí</button>
                            <div class="counter-value" id="readersCount">0</div>
                            <button class="counter-btn" onclick="updateCounter('readersCount', 1)">+</button>
                        </div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="nav-btn primary" onclick="nextStep()">Next Step ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Step 2: Printers -->
        <div id="step2" class="step-content">
            <div class="card">
                <h2>Printers</h2>
                <p class="help-text" style="margin-bottom: 16px;">How many printers do you need? You'll configure placement details in the next step.</p>
                
                <div class="counter-group">
                    <div class="counter-item">
                        <div class="counter-label">Receipt Printers</div>
                        <div class="counter-controls">
                            <button class="counter-btn" onclick="updatePrinterCount('receipt', -1)">‚àí</button>
                            <div class="counter-value" id="receiptCount">0</div>
                            <button class="counter-btn" onclick="updatePrinterCount('receipt', 1)">+</button>
                        </div>
                    </div>
                    <div class="counter-item">
                        <div class="counter-label">Kitchen Printers</div>
                        <div class="counter-controls">
                            <button class="counter-btn" onclick="updatePrinterCount('kitchen', -1)">‚àí</button>
                            <div class="counter-value" id="kitchenCount">0</div>
                            <button class="counter-btn" onclick="updatePrinterCount('kitchen', 1)">+</button>
                        </div>
                    </div>
                    <div class="counter-item">
                        <div class="counter-label">Label Printers</div>
                        <div class="counter-controls">
                            <button class="counter-btn" onclick="updatePrinterCount('label', -1)">‚àí</button>
                            <div class="counter-value" id="labelCount">0</div>
                            <button class="counter-btn" onclick="updatePrinterCount('label', 1)">+</button>
                        </div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="nav-btn secondary" onclick="previousStep()">‚Üê Previous</button>
                    <button class="nav-btn primary" onclick="nextStep()">Next Step ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Printer Placement -->
        <div id="step3" class="step-content">
            <div class="card">
                <h2>Printer Placement & Station Assignment</h2>
                <p class="help-text" style="margin-bottom: 16px;">For each printer, specify location, station pairing, and cable requirements</p>
                
                <div id="printersPlacementContainer"></div>

                <div class="nav-buttons">
                    <button class="nav-btn secondary" onclick="previousStep()">‚Üê Previous</button>
                    <button class="nav-btn primary" onclick="nextStep()">Next Step ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Step 4: Infrastructure -->
        <div id="step4" class="step-content">
            <div class="card">
                <h2>Infrastructure</h2>
                
                <div class="form-group">
                    <label>Does the customer have an existing internet connection (ISP)?</label>
                    <div class="button-group">
                        <div class="button-group-item" id="hasInternetYes" onclick="selectInfraOption('hasInternet', true)">Yes, ISP Connection</div>
                        <div class="button-group-item" id="hasInternetNo" onclick="selectInfraOption('hasInternet', false)">No, Need SIM Card</div>
                    </div>
                </div>

                <div id="ispOptions" style="display: none;">
                    <div class="form-group">
                        <label>Where will the Waffle router be located?</label>
                        <select id="routerLocation" onchange="saveState()">
                            <option value="">Select location...</option>
                            <option value="front_of_house">Front of House</option>
                            <option value="back_of_house">Back of House</option>
                            <option value="back_office">Back Office</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Does the customer's ISP router have at least 1 available LAN port for our use?</label>
                        <p class="help-text">We need to connect our Waffle router to their ISP router via 1 LAN port</p>
                        <div class="button-group">
                            <div class="button-group-item" id="hasPortYes" onclick="selectInfraOption('hasPort', true)">Yes</div>
                            <div class="button-group-item" id="hasPortNo" onclick="selectInfraOption('hasPort', false)">No / Not Sure</div>
                        </div>
                    </div>

                    <div id="noPortWarning" style="display: none;">
                        <div class="warning">
                            ‚ö†Ô∏è Please communicate to the customer that we need at least 1 LAN port from their ISP router to connect our Waffle router ecosystem. If they don't have any available ports, they'll need to contact their ISP or use our SIM card option instead.
                        </div>
                    </div>
                </div>

                <div id="simOptions" style="display: none;">
                    <div class="form-group">
                        <label>SIM Card Provider</label>
                        <select id="simProvider" onchange="handleSimProviderChange()">
                            <option value="">Select provider...</option>
                            <option value="singtel_heya">Singtel Heya (Recommended)</option>
                            <option value="m1_maxx">M1 Maxx (Recommended)</option>
                            <option value="starhub_prepaid">Starhub Prepaid (Recommended)</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div id="simProviderOther" style="display: none;">
                        <div class="form-group">
                            <label>Specify SIM Provider</label>
                            <input type="text" id="simProviderOtherText" placeholder="e.g., Circles Life, TPG" oninput="saveState()">
                        </div>
                        <div class="warning">
                            ‚ö†Ô∏è Non-recommended SIM providers (Circles Life, TPG) may have network compatibility issues with our routers. Verify with customer before proceeding.
                        </div>
                    </div>

                    <div class="info" style="margin-top: 12px;">
                        ‚ÑπÔ∏è Note: Our MR505 router requires a physical SIM card (no eSIM support). Ensure the SIM card is the correct size.
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="nav-btn secondary" onclick="previousStep()">‚Üê Previous</button>
                    <button class="nav-btn primary" onclick="nextStep()">Next Step ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Step 5: Review -->
        <div id="step5" class="step-content">
            <div class="card">
                <h2>Order Summary</h2>
                <div id="reviewContent"></div>
                <button class="copy-btn" onclick="copyToClipboard()">üìã Copy Order to Clipboard</button>
                
                <div class="nav-buttons">
                    <button class="nav-btn secondary" onclick="previousStep()">‚Üê Previous</button>
                    <button class="nav-btn primary" onclick="startNewOrder()">Start New Order</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let state = {
            customerName: '',
            stations: [],
            peripherals: {
                stands: 0,
                drawers: 0,
                readers: 0
            },
            printers: {
                receipt: 0,
                kitchen: 0,
                label: 0
            },
            printersPlacement: [],
            infrastructure: {
                hasInternet: null,
                routerLocation: '',
                hasPort: null,
                simProvider: '',
                simProviderOther: ''
            }
        };

        let stationCounter = 0;

        // Don't auto-restore - start fresh every time
        window.addEventListener('DOMContentLoaded', () => {
            // Always start with first station
            addStation();
        });

        function restoreState() {
            // Restore customer name
            const customerNameEl = document.getElementById('customerName');
            if (customerNameEl) {
                customerNameEl.value = state.customerName || '';
            }

            // Restore stations
            const container = document.getElementById('stationsContainer');
            if (container) {
                container.innerHTML = '';
                state.stations.forEach((station) => {
                    const stationEl = createStationElement(station.id);
                    container.appendChild(stationEl);
                    
                    const posEl = document.getElementById(`hasPOS_${station.id}`);
                    const cdsEl = document.getElementById(`hasCDS_${station.id}`);
                    if (posEl) posEl.checked = station.hasPOS;
                    if (cdsEl) cdsEl.checked = station.hasCDS;
                });
            }

            // Restore peripherals
            const standsEl = document.getElementById('standsCount');
            const drawersEl = document.getElementById('drawersCount');
            const readersEl = document.getElementById('readersCount');
            if (standsEl) standsEl.textContent = state.peripherals.stands || 0;
            if (drawersEl) drawersEl.textContent = state.peripherals.drawers || 0;
            if (readersEl) readersEl.textContent = state.peripherals.readers || 0;

            // Restore printers
            const receiptEl = document.getElementById('receiptCount');
            const kitchenEl = document.getElementById('kitchenCount');
            const labelEl = document.getElementById('labelCount');
            if (receiptEl) receiptEl.textContent = state.printers.receipt || 0;
            if (kitchenEl) kitchenEl.textContent = state.printers.kitchen || 0;
            if (labelEl) labelEl.textContent = state.printers.label || 0;

            // Restore infrastructure
            if (state.infrastructure.hasInternet !== null) {
                selectInfraOption('hasInternet', state.infrastructure.hasInternet);
                if (state.infrastructure.hasInternet) {
                    const routerLocationEl = document.getElementById('routerLocation');
                    if (routerLocationEl) {
                        routerLocationEl.value = state.infrastructure.routerLocation || '';
                    }
                    if (state.infrastructure.hasPort !== null) {
                        selectInfraOption('hasPort', state.infrastructure.hasPort);
                    }
                } else {
                    const simProviderEl = document.getElementById('simProvider');
                    if (simProviderEl) {
                        simProviderEl.value = state.infrastructure.simProvider || '';
                        if (state.infrastructure.simProvider === 'other') {
                            const simProviderOtherDiv = document.getElementById('simProviderOther');
                            const simProviderOtherText = document.getElementById('simProviderOtherText');
                            if (simProviderOtherDiv) simProviderOtherDiv.style.display = 'block';
                            if (simProviderOtherText) simProviderOtherText.value = state.infrastructure.simProviderOther || '';
                        }
                    }
                }
            }

            updateStep1Warnings();
        }

        function saveState() {
            try {
                // Save customer name
                const customerNameEl = document.getElementById('customerName');
                if (customerNameEl) {
                    state.customerName = customerNameEl.value;
                }

                // Save stations
                state.stations = state.stations.map(station => {
                    const id = station.id;
                    return {
                        id: id,
                        hasPOS: document.getElementById(`hasPOS_${id}`)?.checked || false,
                        hasCDS: document.getElementById(`hasCDS_${id}`)?.checked || false
                    };
                });

                // Save peripherals
                const standsEl = document.getElementById('standsCount');
                const drawersEl = document.getElementById('drawersCount');
                const readersEl = document.getElementById('readersCount');
                
                if (standsEl && drawersEl && readersEl) {
                    state.peripherals = {
                        stands: parseInt(standsEl.textContent) || 0,
                        drawers: parseInt(drawersEl.textContent) || 0,
                        readers: parseInt(readersEl.textContent) || 0
                    };
                }

                // Save printers
                const receiptEl = document.getElementById('receiptCount');
                const kitchenEl = document.getElementById('kitchenCount');
                const labelEl = document.getElementById('labelCount');
                
                if (receiptEl && kitchenEl && labelEl) {
                    state.printers = {
                        receipt: parseInt(receiptEl.textContent) || 0,
                        kitchen: parseInt(kitchenEl.textContent) || 0,
                        label: parseInt(labelEl.textContent) || 0
                    };
                }

                // Save infrastructure
                const routerLocationEl = document.getElementById('routerLocation');
                if (routerLocationEl) {
                    state.infrastructure.routerLocation = routerLocationEl.value;
                }
                
                const simProviderEl = document.getElementById('simProvider');
                if (simProviderEl) {
                    state.infrastructure.simProvider = simProviderEl.value;
                }
                
                const simProviderOtherEl = document.getElementById('simProviderOtherText');
                if (simProviderOtherEl) {
                    state.infrastructure.simProviderOther = simProviderOtherEl.value;
                }

                localStorage.setItem('waffleProvisionerState', JSON.stringify(state));
                
                updateStep1Warnings();
            } catch (e) {
                console.error('Failed to save state:', e);
            }
        }

        function updateStep1Warnings() {
            const warningsDiv = document.getElementById('step1Warnings');
            if (!warningsDiv) return;
            
            let warnings = [];

            state.stations.forEach((station, idx) => {
                const posEl = document.getElementById(`hasPOS_${station.id}`);
                const cdsEl = document.getElementById(`hasCDS_${station.id}`);
                
                const hasPOS = posEl?.checked || false;
                const hasCDS = cdsEl?.checked || false;

                if (hasCDS && !hasPOS) {
                    warnings.push(`‚ö†Ô∏è Station ${idx + 1}: CDS iPad requires a POS iPad to pair with. Ensure customer has their own POS iPad.`);
                }

                if (!hasPOS && !hasCDS) {
                    warnings.push(`‚ö†Ô∏è Station ${idx + 1}: No iPads selected. This station will have no equipment.`);
                }
            });

            if (warnings.length > 0) {
                warningsDiv.innerHTML = warnings.map(w => `<div class="warning">${w}</div>`).join('');
            } else {
                warningsDiv.innerHTML = '';
            }
        }

        function addStation() {
            stationCounter++;
            const station = {
                id: stationCounter,
                hasPOS: false,
                hasCDS: false
            };
            state.stations.push(station);
            
            const container = document.getElementById('stationsContainer');
            if (container) {
                const stationEl = createStationElement(station.id);
                container.appendChild(stationEl);
            }
            
            saveState();
        }

        function createStationElement(id) {
            const div = document.createElement('div');
            div.className = 'station-card';
            div.id = `station_${id}`;
            div.innerHTML = `
                <div class="station-header">
                    <div class="station-title">Station ${id}</div>
                    ${state.stations.length > 1 ? `<button class="remove-station-btn" onclick="removeStation(${id})">Remove</button>` : ''}
                </div>

                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="hasPOS_${id}" onchange="saveState()">
                        <label for="hasPOS_${id}">POS iPad</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="hasCDS_${id}" onchange="saveState()">
                        <label for="hasCDS_${id}">CDS iPad</label>
                    </div>
                </div>
            `;
            return div;
        }

        function removeStation(id) {
            state.stations = state.stations.filter(s => s.id !== id);
            const stationEl = document.getElementById(`station_${id}`);
            if (stationEl) {
                stationEl.remove();
            }
            saveState();
        }

        function updateCounter(id, delta) {
            const el = document.getElementById(id);
            if (el) {
                let value = parseInt(el.textContent) || 0;
                value = Math.max(0, value + delta);
                el.textContent = value;
                saveState();
            }
        }

        function updatePrinterCount(type, delta) {
            const id = type + 'Count';
            const el = document.getElementById(id);
            if (el) {
                let value = parseInt(el.textContent) || 0;
                value = Math.max(0, value + delta);
                el.textContent = value;
                saveState();
            }
        }

        function selectInfraOption(key, value) {
            if (key === 'hasInternet') {
                state.infrastructure.hasInternet = value;
                
                // Clear all hasInternet button selections
                const yesBtn = document.getElementById('hasInternetYes');
                const noBtn = document.getElementById('hasInternetNo');
                if (yesBtn) yesBtn.classList.remove('selected');
                if (noBtn) noBtn.classList.remove('selected');
                
                const ispOptions = document.getElementById('ispOptions');
                const simOptions = document.getElementById('simOptions');
                
                if (value === true) {
                    if (ispOptions) ispOptions.style.display = 'block';
                    if (simOptions) simOptions.style.display = 'none';
                    if (yesBtn) yesBtn.classList.add('selected');
                } else {
                    if (ispOptions) ispOptions.style.display = 'none';
                    if (simOptions) simOptions.style.display = 'block';
                    if (noBtn) noBtn.classList.add('selected');
                }
            } else if (key === 'hasPort') {
                state.infrastructure.hasPort = value;
                
                // Clear hasPort button selections
                const yesBtn = document.getElementById('hasPortYes');
                const noBtn = document.getElementById('hasPortNo');
                if (yesBtn) yesBtn.classList.remove('selected');
                if (noBtn) noBtn.classList.remove('selected');
                
                const noPortWarning = document.getElementById('noPortWarning');
                
                if (value === true) {
                    if (noPortWarning) noPortWarning.style.display = 'none';
                    if (yesBtn) yesBtn.classList.add('selected');
                } else {
                    if (noPortWarning) noPortWarning.style.display = 'block';
                    if (noBtn) noBtn.classList.add('selected');
                }
            }
            
            saveState();
        }

        function handleSimProviderChange() {
            const provider = document.getElementById('simProvider')?.value;
            const simProviderOther = document.getElementById('simProviderOther');
            
            if (provider === 'other') {
                if (simProviderOther) simProviderOther.style.display = 'block';
            } else {
                if (simProviderOther) simProviderOther.style.display = 'none';
            }
            saveState();
        }

        function generatePrinterPlacementForms() {
            const container = document.getElementById('printersPlacementContainer');
            if (!container) return;
            
            container.innerHTML = '';

            const totalPrinters = (state.printers.receipt || 0) + (state.printers.kitchen || 0) + (state.printers.label || 0);
            
            if (totalPrinters === 0) {
                container.innerHTML = '<p class="help-text">No printers configured. Go back to Step 2 to add printers.</p>';
                return;
            }

            let printerIndex = 0;

            // Generate forms for receipt printers
            for (let i = 0; i < (state.printers.receipt || 0); i++) {
                const saved = state.printersPlacement[printerIndex];
                container.appendChild(createPrinterPlacementForm('receipt', i + 1, printerIndex, saved));
                printerIndex++;
            }

            // Generate forms for kitchen printers
            for (let i = 0; i < (state.printers.kitchen || 0); i++) {
                const saved = state.printersPlacement[printerIndex];
                container.appendChild(createPrinterPlacementForm('kitchen', i + 1, printerIndex, saved));
                printerIndex++;
            }

            // Generate forms for label printers
            for (let i = 0; i < (state.printers.label || 0); i++) {
                const saved = state.printersPlacement[printerIndex];
                container.appendChild(createPrinterPlacementForm('label', i + 1, printerIndex, saved));
                printerIndex++;
            }
        }

        function createPrinterPlacementForm(type, number, index, saved) {
            const div = document.createElement('div');
            div.className = 'printer-card';
            
            const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
            
            div.innerHTML = `
                <div class="printer-header">${typeLabel} Printer #${number}</div>
                
                <div class="form-group">
                    <label>Physical Location</label>
                    <select id="printerLocation_${index}" onchange="handlePrinterLocationChange(${index}, '${type}')">
                        <option value="">Select location...</option>
                        <option value="front_of_house_counter">Front of House Counter</option>
                        <option value="back_of_house_kitchen">Back of House Kitchen</option>
                        <option value="back_of_house_expeditor">Back of House Expeditor</option>
                        <option value="bar">Bar</option>
                        <option value="back_office">Back Office</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div id="printerLocationOther_${index}_container" style="display: none;">
                    <div class="form-group">
                        <label>Specify Location</label>
                        <input type="text" id="printerLocationOther_${index}" placeholder="e.g., Patio Bar" oninput="savePrinterPlacement(${index}, '${type}')">
                    </div>
                </div>

                <div class="form-group">
                    <label>Paired to Which Station?</label>
                    <select id="printerStation_${index}" onchange="savePrinterPlacement(${index}, '${type}')">
                        <option value="">Select station...</option>
                        ${state.stations.map((s, idx) => {
                            return `<option value="${s.id}">Station ${idx + 1}</option>`;
                        }).join('')}
                    </select>
                </div>

                <div class="form-group">
                    <label>Can we run a visible cable to this printer?</label>
                    <div class="button-group" id="cableGroup_${index}">
                        <div class="button-group-item" onclick="selectPrinterOption(${index}, '${type}', 'canCable', true)">Yes</div>
                        <div class="button-group-item" onclick="selectPrinterOption(${index}, '${type}', 'canCable', false)">No</div>
                    </div>
                </div>

                <div id="outletOptions_${index}" style="display: none;">
                    <div class="form-group">
                        <label>Is there an ethernet outlet at this location?</label>
                        <p class="help-text">An ethernet outlet is a wall-mounted socket (like a power outlet) with in-wall cabling</p>
                        <div class="button-group" id="outletGroup_${index}">
                            <div class="button-group-item" onclick="selectPrinterOption(${index}, '${type}', 'hasOutlet', true)">Yes</div>
                            <div class="button-group-item" onclick="selectPrinterOption(${index}, '${type}', 'hasOutlet', false)">No</div>
                        </div>
                    </div>
                </div>

                <div id="cableLengthOptions_${index}" style="display: none;">
                    <div class="form-group">
                        <label>Cable length needed</label>
                        <div class="button-group" id="lengthGroup_${index}">
                            <div class="button-group-item" onclick="selectPrinterOption(${index}, '${type}', 'cableLength', 5)">< 5M</div>
                            <div class="button-group-item" onclick="selectPrinterOption(${index}, '${type}', 'cableLength', 10)">< 10M</div>
                            <div class="button-group-item" onclick="selectPrinterOption(${index}, '${type}', 'cableLength', 15)">> 10M</div>
                        </div>
                    </div>
                </div>

                <div id="wifiDistanceOptions_${index}" style="display: none;">
                    <div class="form-group">
                        <label>Distance from router location</label>
                        <div class="button-group" id="distanceGroup_${index}">
                            <div class="button-group-item" onclick="selectPrinterOption(${index}, '${type}', 'distance', 'under10')">< 10M</div>
                            <div class="button-group-item" onclick="selectPrinterOption(${index}, '${type}', 'distance', 'over10')">> 10M</div>
                        </div>
                    </div>
                </div>
            `;

            // Restore saved values if they exist
            setTimeout(() => {
                if (saved) {
                    const locationEl = document.getElementById(`printerLocation_${index}`);
                    if (locationEl) {
                        locationEl.value = saved.location || '';
                        if (saved.location === 'other') {
                            const otherContainer = document.getElementById(`printerLocationOther_${index}_container`);
                            const otherText = document.getElementById(`printerLocationOther_${index}`);
                            if (otherContainer) otherContainer.style.display = 'block';
                            if (otherText) otherText.value = saved.locationCustom || '';
                        }
                    }
                    
                    const stationEl = document.getElementById(`printerStation_${index}`);
                    if (stationEl) stationEl.value = saved.stationId || '';
                    
                    if (saved.canCable !== undefined) {
                        selectPrinterOption(index, type, 'canCable', saved.canCable);
                        if (saved.canCable && saved.hasOutlet !== undefined) {
                            selectPrinterOption(index, type, 'hasOutlet', saved.hasOutlet);
                            if (saved.cableLength) {
                                selectPrinterOption(index, type, 'cableLength', saved.cableLength);
                            }
                        } else if (!saved.canCable && saved.distance) {
                            selectPrinterOption(index, type, 'distance', saved.distance);
                        }
                    }
                }
            }, 0);

            return div;
        }

        function handlePrinterLocationChange(index, type) {
            const select = document.getElementById(`printerLocation_${index}`);
            const otherContainer = document.getElementById(`printerLocationOther_${index}_container`);
            
            if (select && otherContainer) {
                if (select.value === 'other') {
                    otherContainer.style.display = 'block';
                } else {
                    otherContainer.style.display = 'none';
                }
            }
            
            savePrinterPlacement(index, type);
        }

        function selectPrinterOption(index, type, key, value) {
            if (!state.printersPlacement[index]) {
                state.printersPlacement[index] = { type: type };
            }

            state.printersPlacement[index][key] = value;

            // Clear all selections in the relevant group first
            if (key === 'canCable') {
                const group = document.getElementById(`cableGroup_${index}`);
                if (group) {
                    group.querySelectorAll('.button-group-item').forEach(btn => btn.classList.remove('selected'));
                    const buttons = group.querySelectorAll('.button-group-item');
                    buttons.forEach(btn => {
                        if ((value === true && btn.textContent.trim() === 'Yes') ||
                            (value === false && btn.textContent.trim() === 'No')) {
                            btn.classList.add('selected');
                        }
                    });
                }
                
                const outletOptions = document.getElementById(`outletOptions_${index}`);
                const cableLengthOptions = document.getElementById(`cableLengthOptions_${index}`);
                const wifiDistanceOptions = document.getElementById(`wifiDistanceOptions_${index}`);
                
                if (value === true) {
                    // Can run cable - ask about outlet
                    if (outletOptions) outletOptions.style.display = 'block';
                    if (cableLengthOptions) cableLengthOptions.style.display = 'none';
                    if (wifiDistanceOptions) wifiDistanceOptions.style.display = 'none';
                } else {
                    // Cannot run cable - WiFi distance question
                    if (outletOptions) outletOptions.style.display = 'none';
                    if (cableLengthOptions) cableLengthOptions.style.display = 'none';
                    if (wifiDistanceOptions) wifiDistanceOptions.style.display = 'block';
                }
            } else if (key === 'hasOutlet') {
                const group = document.getElementById(`outletGroup_${index}`);
                if (group) {
                    group.querySelectorAll('.button-group-item').forEach(btn => btn.classList.remove('selected'));
                }
                
                // Find and select the clicked button
                if (group) {
                    const buttons = group.querySelectorAll('.button-group-item');
                    buttons.forEach(btn => {
                        if ((value === true && btn.textContent.trim() === 'Yes') ||
                            (value === false && btn.textContent.trim() === 'No')) {
                            btn.classList.add('selected');
                        }
                    });
                }
                
                const cableLengthOptions = document.getElementById(`cableLengthOptions_${index}`);
                
                // Both yes and no to outlet show cable length (since we know cable can run)
                if (cableLengthOptions) cableLengthOptions.style.display = 'block';
            } else if (key === 'cableLength') {
                const group = document.getElementById(`lengthGroup_${index}`);
                if (group) {
                    group.querySelectorAll('.button-group-item').forEach(btn => btn.classList.remove('selected'));
                    const buttons = group.querySelectorAll('.button-group-item');
                    buttons.forEach(btn => {
                        const text = btn.textContent.trim();
                        if ((value === 5 && text === '< 5M') ||
                            (value === 10 && text === '< 10M') ||
                            (value === 15 && text === '> 10M')) {
                            btn.classList.add('selected');
                        }
                    });
                }
            } else if (key === 'distance') {
                const group = document.getElementById(`distanceGroup_${index}`);
                if (group) {
                    group.querySelectorAll('.button-group-item').forEach(btn => btn.classList.remove('selected'));
                    const buttons = group.querySelectorAll('.button-group-item');
                    buttons.forEach(btn => {
                        const text = btn.textContent.trim();
                        if ((value === 'under10' && text === '< 10M') ||
                            (value === 'over10' && text === '> 10M')) {
                            btn.classList.add('selected');
                        }
                    });
                }
            }

            saveState();
        }

        function savePrinterPlacement(index, type) {
            if (!state.printersPlacement[index]) {
                state.printersPlacement[index] = { type: type };
            }

            const locationEl = document.getElementById(`printerLocation_${index}`);
            if (locationEl) {
                const location = locationEl.value;
                state.printersPlacement[index].location = location;
                
                if (location === 'other') {
                    const locationCustomEl = document.getElementById(`printerLocationOther_${index}`);
                    if (locationCustomEl) {
                        state.printersPlacement[index].locationCustom = locationCustomEl.value;
                    }
                }
            }

            const stationEl = document.getElementById(`printerStation_${index}`);
            if (stationEl) {
                state.printersPlacement[index].stationId = stationEl.value;
            }

            saveState();
        }

        function nextStep() {
            if (currentStep === 2) {
                generatePrinterPlacementForms();
            }

            if (currentStep === 4) {
                generateReview();
            }

            if (currentStep < 5) {
                currentStep++;
                updateStepDisplay();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }

        function goToStep(step) {
            currentStep = step;
            
            if (currentStep === 3) {
                generatePrinterPlacementForms();
            }
            
            if (currentStep === 5) {
                generateReview();
            }
            
            updateStepDisplay();
        }

        function updateStepDisplay() {
            // Hide all steps
            for (let i = 1; i <= 5; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (stepEl) stepEl.classList.remove('active');
            }

            // Show current step
            const currentStepEl = document.getElementById(`step${currentStep}`);
            if (currentStepEl) currentStepEl.classList.add('active');

            // Update progress bar
            document.querySelectorAll('.progress-step').forEach((el, index) => {
                el.classList.remove('active', 'completed');
                if (index + 1 === currentStep) {
                    el.classList.add('active');
                } else if (index + 1 < currentStep) {
                    el.classList.add('completed');
                }
            });

            // Scroll to top
            window.scrollTo(0, 0);
        }

        function generateReview() {
            const container = document.getElementById('reviewContent');
            if (!container) return;
            
            let html = '';

            // Customer Name
            html += `<div class="review-section">`;
            html += `<h3>Customer</h3>`;
            html += `<div class="review-item"><strong>${state.customerName || 'Not specified'}</strong></div>`;
            html += `</div>`;

            // POS Stations
            html += `<div class="review-section">`;
            html += `<h3>POS Stations</h3>`;
            
            state.stations.forEach((station, idx) => {
                html += `<div class="review-item"><strong>Station ${idx + 1}</strong></div>`;
                
                if (station.hasPOS) html += `<div class="review-item review-item-indent">1x iPad (POS)</div>`;
                if (station.hasCDS) html += `<div class="review-item review-item-indent">1x iPad (CDS)</div>`;
            });

            html += `</div>`;

            // Peripherals - Auto-allocated sequentially to stations
            if (state.peripherals.stands > 0 || state.peripherals.drawers > 0 || state.peripherals.readers > 0) {
                html += `<div class="review-section">`;
                html += `<h3>Peripherals</h3>`;
                
                let standsRemaining = state.peripherals.stands || 0;
                let drawersRemaining = state.peripherals.drawers || 0;
                let readersRemaining = state.peripherals.readers || 0;
                
                state.stations.forEach((station, idx) => {
                    const stationPeripherals = [];
                    
                    // Allocate stand (1 stand can hold POS + CDS)
                    if (standsRemaining > 0 && (station.hasPOS || station.hasCDS)) {
                        stationPeripherals.push('1x POS Stand');
                        standsRemaining--;
                    }
                    
                    // Allocate drawer (1 per station)
                    if (drawersRemaining > 0) {
                        stationPeripherals.push('1x Cash Drawer');
                        drawersRemaining--;
                    }
                    
                    // Allocate reader (only to stations with POS)
                    if (readersRemaining > 0 && station.hasPOS) {
                        stationPeripherals.push('1x Card Reader');
                        readersRemaining--;
                    }
                    
                    if (stationPeripherals.length > 0) {
                        html += `<div class="review-item"><strong>Station ${idx + 1}:</strong></div>`;
                        stationPeripherals.forEach(item => {
                            html += `<div class="review-item review-item-indent">${item}</div>`;
                        });
                    }
                });
                
                // Show unallocated peripherals if any
                if (standsRemaining > 0 || drawersRemaining > 0 || readersRemaining > 0) {
                    html += `<div class="review-item" style="margin-top: 12px;"><strong>Unallocated (spares):</strong></div>`;
                    if (standsRemaining > 0) html += `<div class="review-item review-item-indent">${standsRemaining}x POS Stand${standsRemaining > 1 ? 's' : ''}</div>`;
                    if (drawersRemaining > 0) html += `<div class="review-item review-item-indent">${drawersRemaining}x Cash Drawer${drawersRemaining > 1 ? 's' : ''}</div>`;
                    if (readersRemaining > 0) html += `<div class="review-item review-item-indent">${readersRemaining}x Card Reader${readersRemaining > 1 ? 's' : ''}</div>`;
                }
                
                html += `</div>`;
            }

            // Printers (grouped by location)
            const printersByLocation = {};
            
            state.printersPlacement.forEach(placement => {
                if (placement && placement.location) {
                    const loc = placement.location === 'other' ? placement.locationCustom : formatLocation(placement.location);
                    if (!printersByLocation[loc]) {
                        printersByLocation[loc] = [];
                    }
                    
                    const printerInfo = {
                        type: placement.type || 'unknown',
                        placement: placement,
                        stationName: getStationName(placement.stationId)
                    };
                    
                    printersByLocation[loc].push(printerInfo);
                }
            });

            if (Object.keys(printersByLocation).length > 0) {
                html += `<div class="review-section">`;
                html += `<h3>Printers</h3>`;

                Object.keys(printersByLocation).forEach(location => {
                    html += `<div class="review-item"><strong>${location}</strong></div>`;
                    
                    printersByLocation[location].forEach(printer => {
                        const model = getPrinterModel(printer.type, printer.placement);
                        const connection = getPrinterConnection(printer.placement);
                        const typeLabel = printer.type.charAt(0).toUpperCase() + printer.type.slice(1);
                        html += `<div class="review-item review-item-indent">1x ${model} ${typeLabel} (${connection}, paired to ${printer.stationName})</div>`;
                    });
                });

                html += `</div>`;
            }

            // Network Equipment
            const networkEquipment = calculateNetworkEquipment();
            html += `<div class="review-section">`;
            html += `<h3>Network Equipment</h3>`;
            html += `<div class="review-item">${networkEquipment.router}</div>`;
            if (networkEquipment.switch) {
                html += `<div class="review-item">${networkEquipment.switch}</div>`;
            }
            if (networkEquipment.cables) {
                html += `<div class="review-item">${networkEquipment.cables}</div>`;
            }
            html += `</div>`;

            // Installation Complexity
            const complexity = calculateComplexity();
            html += `<div class="review-section">`;
            html += `<h3>Installation Complexity</h3>`;
            html += `<div class="complexity-badge complexity-${complexity.level.toLowerCase()}">${complexity.level} - ${complexity.time}</div>`;
            html += `</div>`;

            container.innerHTML = html;
        }

        function getStationPrinters(stationId) {
            const printers = [];
            
            state.printersPlacement.forEach(placement => {
                if (placement && placement.stationId == stationId && placement.location && placement.type) {
                    const loc = placement.location === 'other' ? placement.locationCustom : formatLocation(placement.location);
                    const model = getPrinterModel(placement.type, placement);
                    const connection = getPrinterConnection(placement);
                    const typeLabel = placement.type.charAt(0).toUpperCase() + placement.type.slice(1);
                    printers.push(`1x ${model} ${typeLabel} (at ${loc}, ${connection})`);
                }
            });
            
            return printers;
        }

        function getStationName(stationId) {
            const station = state.stations.find(s => s.id == stationId);
            if (!station) return 'Unknown Station';
            
            const stationIndex = state.stations.indexOf(station);
            return `Station ${stationIndex + 1}`;
        }

        function getPrinterModel(type, placement) {
            if (type === 'label') return 'ZD411';
            
            if (placement.hasOutlet || (placement.canCable && placement.cableLength !== 15)) {
                return 'TM-T82X';
            }
            
            return 'M30-III';
        }

        function getPrinterConnection(placement) {
            if (placement.hasOutlet) {
                return `LAN ${placement.cableLength || 5}M`;
            }
            
            if (placement.canCable) {
                if (placement.cableLength === 15) {
                    return 'WiFi (>10M, recommend M30-III)';
                }
                return `LAN ${placement.cableLength}M`;
            }
            
            if (placement.distance === 'over10') {
                return 'WiFi (>10M, may need router upgrade)';
            }
            
            return 'WiFi';
        }

        function calculateNetworkEquipment() {
            let router = '';
            let needsSwitch = false;
            let wiredCount = 0;
            
            // Count wired printers
            state.printersPlacement.forEach(p => {
                if (p && (p.hasOutlet || (p.canCable && p.cableLength !== 15))) {
                    wiredCount++;
                }
            });

            // Determine router
            const hasLongRangeNeeds = state.printersPlacement.some(p => 
                p && (!p.hasOutlet && !p.canCable && p.distance === 'over10')
            );

            if (state.infrastructure.hasInternet) {
                router = hasLongRangeNeeds ? '1x ER706W4G-V2 Router' : '1x ER605W Router';
                
                // Check if switch needed - if they don't have a port, we need a switch
                if (state.infrastructure.hasPort === false || wiredCount > 1) {
                    needsSwitch = true;
                }
            } else {
                router = hasLongRangeNeeds ? '1x ER706W Router' : '1x MR505 Router';
                
                // Check if switch needed based on router ports
                const routerPorts = hasLongRangeNeeds ? 4 : 3;
                if (wiredCount > routerPorts) {
                    needsSwitch = true;
                }
            }

            // Calculate cables
            const cableCounts = { 5: 0, 10: 0 };
            state.printersPlacement.forEach(p => {
                if (p && (p.hasOutlet || p.canCable)) {
                    if (p.cableLength === 5) cableCounts[5]++;
                    else if (p.cableLength === 10) cableCounts[10]++;
                }
            });

            let cables = '';
            if (cableCounts[5] > 0) cables += `${cableCounts[5]}x 5M Ethernet Cable, `;
            if (cableCounts[10] > 0) cables += `${cableCounts[10]}x 10M Ethernet Cable`;
            cables = cables.replace(/, $/, '');

            return {
                router,
                switch: needsSwitch ? '1x 5-Port Switch' : null,
                cables: cables || null
            };
        }

        function calculateComplexity() {
            let wiredPrinters = 0;
            let totalPrinters = (state.printers.receipt || 0) + (state.printers.kitchen || 0) + (state.printers.label || 0);
            
            state.printersPlacement.forEach(p => {
                if (p && (p.hasOutlet || (p.canCable && p.cableLength !== 15))) {
                    wiredPrinters++;
                }
            });

            const hasSwitch = calculateNetworkEquipment().switch !== null;
            const hasLabelWithoutCable = state.printersPlacement.some(p => 
                p && p.type === 'label' && !p.hasOutlet && !p.canCable
            );

            if (totalPrinters > 5 || hasLabelWithoutCable) {
                return { level: 'HIGH', time: '2 hours' };
            }

            if (wiredPrinters > 2 || hasSwitch) {
                return { level: 'MEDIUM', time: '1.5 hours' };
            }

            return { level: 'LOW', time: '1 hour' };
        }

        function formatLocation(loc) {
            if (!loc) return '';
            return loc.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }

        function copyToClipboard() {
            const text = generateOrderText();
            const btn = document.querySelector('.copy-btn');
            const originalText = btn ? btn.innerHTML : '';
            
            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopySuccess(btn, originalText);
                }).catch(err => {
                    console.error('Clipboard API failed:', err);
                    fallbackCopyToClipboard(text, btn, originalText);
                });
            } else {
                fallbackCopyToClipboard(text, btn, originalText);
            }
        }

        function showCopySuccess(btn, originalText) {
            if (btn) {
                btn.innerHTML = '‚úì Copied to Clipboard!';
                btn.style.background = '#166534';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#0a0a0a';
                }, 2000);
            }
        }

        function fallbackCopyToClipboard(text, btn, originalText) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess(btn, originalText);
                } else {
                    alert('Failed to copy. Please copy manually from the review.');
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                alert('Failed to copy. Please copy manually from the review.');
            }
            
            document.body.removeChild(textArea);
        }

        function generateOrderText() {
            let text = '=== WAFFLE HARDWARE ORDER ===\n\n';
            text += `CUSTOMER: ${state.customerName || 'Not specified'}\n\n`;

            // Stations
            text += '## POS STATIONS\n\n';
            state.stations.forEach((station, idx) => {
                text += `Station ${idx + 1}:\n`;
                if (station.hasPOS) text += '  - 1x iPad (POS)\n';
                if (station.hasCDS) text += '  - 1x iPad (CDS)\n';
                text += '\n';
            });

            // Peripherals - Auto-allocated
            if (state.peripherals.stands > 0 || state.peripherals.drawers > 0 || state.peripherals.readers > 0) {
                text += '## PERIPHERALS\n\n';
                
                let standsRemaining = state.peripherals.stands || 0;
                let drawersRemaining = state.peripherals.drawers || 0;
                let readersRemaining = state.peripherals.readers || 0;
                
                state.stations.forEach((station, idx) => {
                    const stationPeripherals = [];
                    
                    if (standsRemaining > 0 && (station.hasPOS || station.hasCDS)) {
                        stationPeripherals.push('1x POS Stand');
                        standsRemaining--;
                    }
                    
                    if (drawersRemaining > 0) {
                        stationPeripherals.push('1x Cash Drawer');
                        drawersRemaining--;
                    }
                    
                    if (readersRemaining > 0 && station.hasPOS) {
                        stationPeripherals.push('1x Card Reader');
                        readersRemaining--;
                    }
                    
                    if (stationPeripherals.length > 0) {
                        text += `Station ${idx + 1}:\n`;
                        stationPeripherals.forEach(item => text += `  - ${item}\n`);
                        text += '\n';
                    }
                });
                
                if (standsRemaining > 0 || drawersRemaining > 0 || readersRemaining > 0) {
                    text += 'Unallocated (spares):\n';
                    if (standsRemaining > 0) text += `  - ${standsRemaining}x POS Stand\n`;
                    if (drawersRemaining > 0) text += `  - ${drawersRemaining}x Cash Drawer\n`;
                    if (readersRemaining > 0) text += `  - ${readersRemaining}x Card Reader\n`;
                    text += '\n';
                }
            }

            // Printers
            const printersByLocation = {};
            
            state.printersPlacement.forEach(placement => {
                if (placement && placement.location && placement.type) {
                    const loc = placement.location === 'other' ? placement.locationCustom : formatLocation(placement.location);
                    if (!printersByLocation[loc]) {
                        printersByLocation[loc] = [];
                    }
                    
                    printersByLocation[loc].push({
                        type: placement.type,
                        placement: placement,
                        stationName: getStationName(placement.stationId)
                    });
                }
            });

            if (Object.keys(printersByLocation).length > 0) {
                text += '## PRINTERS\n\n';
                Object.keys(printersByLocation).forEach(location => {
                    text += `${location}:\n`;
                    printersByLocation[location].forEach(printer => {
                        const model = getPrinterModel(printer.type, printer.placement);
                        const connection = getPrinterConnection(printer.placement);
                        const typeLabel = printer.type.charAt(0).toUpperCase() + printer.type.slice(1);
                        text += `  - 1x ${model} ${typeLabel} (${connection}, paired to ${printer.stationName})\n`;
                    });
                    text += '\n';
                });
            }

            // Network
            const network = calculateNetworkEquipment();
            text += '## NETWORK EQUIPMENT\n\n';
            text += `  - ${network.router}\n`;
            if (network.switch) text += `  - ${network.switch}\n`;
            if (network.cables) text += `  - ${network.cables}\n`;
            text += '\n';

            // Complexity
            const complexity = calculateComplexity();
            text += `## INSTALLATION\n\n`;
            text += `Complexity: ${complexity.level} (${complexity.time})\n`;

            return text;
        }

        function startNewOrder() {
            if (confirm('Start a new order? Current order will be cleared.')) {
                // Clear localStorage
                localStorage.removeItem('waffleProvisionerState');
                
                // Reset state
                state = {
                    customerName: '',
                    stations: [],
                    peripherals: { stands: 0, drawers: 0, readers: 0 },
                    printers: { receipt: 0, kitchen: 0, label: 0 },
                    printersPlacement: [],
                    infrastructure: {
                        hasInternet: null,
                        routerLocation: '',
                        hasPort: null,
                        simProvider: '',
                        simProviderOther: ''
                    }
                };
                stationCounter = 0;
                
                // Clear customer name
                const customerNameEl = document.getElementById('customerName');
                if (customerNameEl) customerNameEl.value = '';
                
                // Clear stations container
                const stationsContainer = document.getElementById('stationsContainer');
                if (stationsContainer) stationsContainer.innerHTML = '';
                
                // Reset peripherals counters
                const standsEl = document.getElementById('standsCount');
                const drawersEl = document.getElementById('drawersCount');
                const readersEl = document.getElementById('readersCount');
                if (standsEl) standsEl.textContent = '0';
                if (drawersEl) drawersEl.textContent = '0';
                if (readersEl) readersEl.textContent = '0';
                
                // Reset printer counters
                const receiptEl = document.getElementById('receiptCount');
                const kitchenEl = document.getElementById('kitchenCount');
                const labelEl = document.getElementById('labelCount');
                if (receiptEl) receiptEl.textContent = '0';
                if (kitchenEl) kitchenEl.textContent = '0';
                if (labelEl) labelEl.textContent = '0';
                
                // Clear infrastructure selections
                const ispOptionsEl = document.getElementById('ispOptions');
                const simOptionsEl = document.getElementById('simOptions');
                if (ispOptionsEl) ispOptionsEl.style.display = 'none';
                if (simOptionsEl) simOptionsEl.style.display = 'none';
                
                // Clear button selections
                document.querySelectorAll('.button-group-item.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // Reset dropdowns
                const routerLocationEl = document.getElementById('routerLocation');
                const simProviderEl = document.getElementById('simProvider');
                if (routerLocationEl) routerLocationEl.value = '';
                if (simProviderEl) simProviderEl.value = '';
                
                // Add first station
                addStation();
                
                // Go back to step 1
                currentStep = 1;
                updateStepDisplay();
            }
        }
    </script>
</body>
</html>
